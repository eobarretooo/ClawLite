name: CI — Testes e Qualidade

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    name: Pytest (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Instalar dependências
        run: |
          pip install --upgrade pip
          if python - <<'PY'
          import pathlib
          try:
              import tomllib
          except Exception:
              import tomli as tomllib  # type: ignore
          data = tomllib.loads(pathlib.Path('pyproject.toml').read_text(encoding='utf-8'))
          optional = (data.get('project', {}) or {}).get('optional-dependencies', {}) or {}
          raise SystemExit(0 if 'dev' in optional else 1)
          PY
          then
            pip install -e ".[dev]"
          else
            pip install -e .
          fi
          pip install pytest pytest-anyio httpx "fastapi[all]" uvicorn questionary rich

      - name: Rodar testes
        run: python -m pytest tests/ -q --tb=short

  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Instalar ruff
        run: pip install ruff

      - name: Verificar formatação e linting
        # Falha em erros críticos (E9xx = erros de runtime, F = pyflakes)
        run: ruff check clawlite/ --select E9,F --ignore F401,F811

  smoke:
    name: Smoke test (doctor)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Instalar ClawLite
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install httpx fastapi uvicorn rich questionary

      - name: Smoke — importação dos módulos principais
        run: |
          python -c "from clawlite.gateway import server; print('gateway ok')"
          python -c "from clawlite.runtime import multiagent; print('multiagent ok')"
          python -c "from clawlite.runtime import offline; print('offline ok')"
          python -c "from clawlite.runtime import resilience; print('resilience ok')"
          python -c "from clawlite.runtime import secret_store; print('secret_store ok')"
