<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ClawLite Dashboard Premium</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Configurando Tailwind com paleta premium Dark Mode -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            fox: {
              50: '#fff3ec',
              100: '#ffe4d3',
              500: '#ff6b2b',
              600: '#ea4f0d',
              700: '#c2380a',
              900: '#7e260b',
            },
            drk: {
              900: '#0b1020', // bg ultra escuro (sidebar)
              800: '#111934', // paineis
              700: '#1c284d', // bordas
              600: '#2a3b6e', // hovers
              300: '#9fb3de', // texto muted
              100: '#eaf1ff', // texto principal
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'Menlo', 'monospace'],
          }
        }
      }
    }
  </script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel para compilar JSX in-browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      background-color: #0b1020;
      color: #eaf1ff;
      background-image: radial-gradient(circle at top left, #173366 0%, #0b1020 40%);
      background-attachment: fixed;
    }

    /* Custom Scrollbar Premium */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #2a3b6e;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #ff6b2b;
    }

    /* Loader Animation */
    .loader {
      border: 3px solid rgba(255, 107, 43, 0.2);
      border-bottom-color: #ff6b2b;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }

    @keyframes rotation {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="antialiased selection:bg-fox-500 selection:text-white overflow-hidden">
  <div id="root"></div>

  <script type="text/babel">
    // --- Utils e Context API Globais ---
    const { useState, useEffect, useRef, useMemo, createContext, useContext } = React;

    // Criando contexto global de AppState para n√£o passar props eternamente
    const AppContext = createContext();

    // Config de Tabs que espelha os √≠cones da Lucide com a label
    const TABS = [
      { id: 'chat', label: 'Chat', icon: 'message-square' },
      { id: 'sessions', label: 'Sessions', icon: 'server' },
      { id: 'cron', label: 'Cron Jobs', icon: 'clock' },
      { id: 'channels', label: 'Channels', icon: 'satellite-dish' },
      { id: 'config', label: 'System Config', icon: 'settings' },
      { id: 'workspace', label: 'Workspace', icon: 'folder-code' },
      { id: 'skills', label: 'Skills Hub', icon: 'blocks' },
      { id: 'telemetry', label: 'Telemetria', icon: 'bar-chart-3' },
      { id: 'logs', label: 'Realtime Logs', icon: 'terminal' }
    ];

    // Componente utilit√°rio de Card
    const Card = ({ children, className = "" }) => (
      <div className={`bg-gradient-to-b from-drk-800 to-drk-900 border border-drk-700 rounded-xl p-4 shadow-xl ${className}`}>
        {children}
      </div>
    );

    // Componente √çcone
    const Icon = ({ name, size = 18, className = "" }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && window.lucide) {
          lucide.createIcons({
            icons: { [name.replace(/-/g, '')]: window.lucide.icons[name.replace(/-(.)/g, (_, c) => c.toUpperCase())] } || window.lucide.icons,
            nameAttr: 'data-lucide',
            root: ref.current.parentNode
          });
        }
      }, [name]);
      return <i ref={ref} data-lucide={name} style={{ width: size, height: size }} className={className} />;
    };

    // --- Sidebar (Painel de Status e Menu) ---
    const Sidebar = () => {
      const {
        tab, setTab,
        token, setToken,
        status, isConnected, doLogin
      } = useContext(AppContext);

      const handleTokenChange = (e) => setToken(e.target.value);

      return (
        <aside className="w-72 flex-shrink-0 border-r border-drk-700 bg-drk-900/50 backdrop-blur top-0 h-screen flex flex-col p-4 overflow-y-auto">
          {/* Header Logo */}
          <div className="flex items-center gap-3 mb-6 mix-blend-screen">
            <div className="bg-fox-500/10 p-2 rounded-lg border border-fox-500/30">
              <span className="text-2xl" role="img" aria-label="fox">ü¶ä</span>
            </div>
            <div>
              <h1 className="font-bold tracking-tight text-white text-lg">ClawLite</h1>
              <p className="text-xs text-drk-300 font-mono tracking-wider">PREMIUM ENGINE</p>
            </div>
          </div>

          {/* Authentication Card */}
          <Card className="mb-4">
            <h2 className="text-xs font-bold text-drk-300 uppercase tracking-wider mb-2 flex items-center gap-2">
              <Icon name="key" size={14} /> Node Authentication
            </h2>
            {!isConnected ? (
              <div className="space-y-2">
                <input
                  type="password"
                  value={token}
                  onChange={handleTokenChange}
                  placeholder="Insert Bearer Token"
                  className="w-full bg-drk-900 border border-drk-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-fox-500 focus:ring-1 focus:ring-fox-500"
                />
                <button
                  onClick={doLogin}
                  className="w-full bg-fox-600 hover:bg-fox-500 text-white font-medium rounded-lg px-3 py-2 text-sm transition-colors shadow-lg shadow-fox-500/20"
                >
                  Connect to Gateway
                </button>
              </div>
            ) : (
              <div className="flex items-center justify-between bg-drk-900 border border-drk-700 rounded-lg p-2">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                  <span className="text-sm font-mono text-drk-100">‚Ä¢‚Ä¢‚Ä¢‚Ä¢{token.slice(-4)}</span>
                </div>
                <button onClick={() => setToken('')} className="text-xs text-drk-300 hover:text-red-400">Disconnect</button>
              </div>
            )}
          </Card>

          {/* Status Dashboard Mini (Only if connected) */}
          {isConnected && (
            <div className="mb-6 space-y-3 pl-1">
              <div className="flex justify-between items-center text-sm">
                <span className="text-drk-300 flex items-center gap-2">
                  <Icon name="activity" size={14} /> Core Status
                </span>
                <span className={status?.online ? "text-green-400 font-medium" : "text-red-400 font-medium"}>
                  {status?.online ? 'Online' : 'Offline'}
                </span>
              </div>
              <div className="flex justify-between items-center text-sm">
                <span className="text-drk-300 flex items-center gap-2">
                  <Icon name="cpu" size={14} /> Model
                </span>
                <span className="text-fox-500 font-mono text-xs">{status?.model || '‚Äî'}</span>
              </div>
              <div className="flex justify-between items-center text-sm">
                <span className="text-drk-300 flex items-center gap-2">
                  <Icon name="clock" size={14} /> Uptime
                </span>
                <span className="text-drk-100 font-mono text-xs">{status?.uptime_seconds ? `${Math.floor(status.uptime_seconds / 3600)}h ${Math.floor((status.uptime_seconds % 3600) / 60)}m` : '‚Äî'}</span>
              </div>
            </div>
          )}

          <div className="mt-2 text-xs font-bold text-drk-300 uppercase tracking-wider mb-2 pl-2">Navigation</div>

          {/* Navigation Menu (Tabs) */}
          <nav className="flex-1 space-y-1">
            {TABS.map(item => (
              <button
                key={item.id}
                onClick={() => setTab(item.id)}
                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all ${tab === item.id
                  ? 'bg-fox-500/10 text-fox-500 border border-fox-500/30 shadow-[inset_0_0_15px_rgba(255,107,43,0.1)]'
                  : 'text-drk-300 hover:bg-drk-800 hover:text-drk-100 border border-transparent'
                  }`}
              >
                <Icon name={item.icon} size={16} />
                {item.label}
              </button>
            ))}
          </nav>
        </aside>
      )
    };

    // --- Screens Mocks (Sprints 5 implementations will expand this) ---
    const ConstructionScreen = ({ title, icon }) => (
      <div className="flex-1 flex flex-col items-center justify-center h-full opacity-50">
        <Icon name={icon} size={64} className="mb-4 text-drk-600" />
        <h2 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-drk-100 to-drk-300">{title}</h2>
        <p className="text-drk-300 mt-2">Esta tela est√° sendo constru√≠da no Sprint 5. ü¶ä</p>
      </div>
    );

    const ChatScreen = () => {
      const { messages, sendMessage, sessionId, setSessionId, isConnected } = useContext(AppContext);
      const [input, setInput] = useState('');
      const chatRef = useRef(null);

      useEffect(() => {
        if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
      }, [messages]);

      const handleSend = () => {
        const text = input.trim();
        if (!text || !isConnected) return;
        sendMessage(text);
        setInput('');
      };

      return (
        <div className="flex flex-col h-full">
          <div className="flex items-center justify-between pb-4 border-b border-drk-700 mb-4">
            <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="message-square" /> Console Engine</h2>
            <input
              className="bg-drk-800 border border-drk-700 text-drk-300 font-mono text-xs px-2 py-1 rounded outline-none focus:border-fox-500 w-48 text-right"
              value={sessionId}
              onChange={(e) => setSessionId(e.target.value)}
              title="Session ID (Context Isolation)"
            />
          </div>

          <div ref={chatRef} className="flex-1 overflow-y-auto bg-drk-900/50 rounded-xl border border-drk-700 p-4 mb-4 space-y-4">
            {messages.length === 0 ? (
              <div className="text-center text-drk-300 text-sm mt-10">
                Sem hist√≥rico ativo na sess√£o corrente.<br />Conecte-se para iniciar a transmiss√£o SSE real-time.
              </div>
            ) : (
              messages.map((msg, idx) => (
                <div key={idx} className={`p-3 rounded-xl max-w-[85%] whitespace-pre-wrap ${msg.role === 'user' ? 'bg-[#1d3768] ml-auto rounded-tr-none' : 'bg-[#1b3221] mr-auto rounded-tl-none border border-green-900/30'}`}>
                  {msg.text}
                </div>
              ))
            )}
          </div>

          <div className="flex gap-2">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handleSend()}
              placeholder="Envie comandos multimodais para o ClawLite..."
              className="flex-1 bg-drk-800 border border-drk-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-fox-500 focus:ring-1 focus:ring-fox-500"
              disabled={!isConnected}
            />
            <button
              onClick={handleSend}
              disabled={!isConnected}
              className={`${isConnected ? 'bg-fox-600 hover:bg-fox-500 shadow-lg shadow-fox-500/20' : 'bg-drk-700 text-drk-400 cursor-not-allowed'} text-white rounded-xl px-4 py-3 font-medium transition-colors flex items-center gap-2`}
            >
              <Icon name="send" size={16} /> Send
            </button>
          </div>
        </div>
      );
    }

    // --- Telemetry Screen ---
    const TelemetryScreen = () => {
      const { apiCall, isConnected } = useContext(AppContext);
      const [data, setData] = useState({ events: 0, sessions: 0, tokens: 0, cost_usd: 0 });
      const [period, setPeriod] = useState('7d');
      const [loading, setLoading] = useState(false);

      const loadTelemetry = async () => {
        if (!isConnected) return;
        setLoading(true);
        try {
          const res = await apiCall(`/api/dashboard/telemetry?period=${period}`);
          if (res.summary) setData(res.summary);
        } catch (e) {
          console.error("Telemetry error", e);
        }
        setLoading(false);
      };

      useEffect(() => { loadTelemetry(); }, [period, isConnected]);

      const KpiCard = ({ title, value, icon, prefix = "" }) => (
        <div className="bg-drk-800 border border-drk-700 p-6 rounded-xl flex flex-col items-center justify-center text-center">
          <Icon name={icon} size={24} className="text-drk-300 mb-2" />
          <span className="text-drk-300 text-sm font-medium uppercase tracking-wider">{title}</span>
          <span className="text-3xl font-bold text-white mt-1">{prefix}{value}</span>
        </div>
      );

      return (
        <div className="flex flex-col h-full">
          <div className="flex items-center justify-between pb-4 border-b border-drk-700 mb-6">
            <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="bar-chart-3" /> LLM Telemetry</h2>
            <div className="flex gap-2 items-center">
              {loading && <div className="loader w-4 h-4"></div>}
              <select
                value={period}
                onChange={(e) => setPeriod(e.target.value)}
                className="bg-drk-800 border border-drk-700 text-sm rounded-lg px-3 py-1.5 outline-none focus:border-fox-500"
              >
                <option value="24h">√öltimas 24h</option>
                <option value="7d">√öltimos 7 dias</option>
                <option value="30d">√öltimos 30 dias</option>
                <option value="all">Todo o Per√≠odo</option>
              </select>
              <button onClick={loadTelemetry} className="bg-drk-800 hover:bg-drk-700 p-1.5 rounded-lg border border-drk-700 text-drk-300">
                <Icon name="refresh-cw" size={16} />
              </button>
            </div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <KpiCard title="Tokens Gerados" value={data.tokens.toLocaleString()} icon="cpu" />
            <KpiCard title="Custo API Estimado" value={Number(data.cost_usd).toFixed(4)} prefix="$" icon="dollar-sign" />
            <KpiCard title="Eventos Processados" value={data.events} icon="activity" />
            <KpiCard title="Sess√µes Ativas" value={data.sessions} icon="users" />
          </div>

          <div className="flex-1 mt-6 bg-drk-900/50 border border-drk-700 rounded-xl p-6 flex items-center justify-center text-drk-300">
            Os gr√°ficos temporais ser√£o renderizados aqui em breve. üìâ
          </div>
        </div>
      );
    };

    // --- Skills Screen ---
    const SkillsScreen = () => {
      const { apiCall, isConnected } = useContext(AppContext);
      const [skills, setSkills] = useState([]);
      const [loading, setLoading] = useState(false);
      const [newSlug, setNewSlug] = useState('');

      const loadSkills = async () => {
        if (!isConnected) return;
        setLoading(true);
        try {
          const res = await apiCall('/api/dashboard/skills');
          setSkills(res.skills || []);
        } catch (e) { }
        setLoading(false);
      };

      const toggleSkill = async (slug, enable) => {
        const endpoint = enable ? '/api/dashboard/skills/enable' : '/api/dashboard/skills/disable';
        await apiCall(endpoint, { method: 'POST', body: JSON.stringify({ slug }) });
        loadSkills();
      };

      const installSkill = async () => {
        if (!newSlug.trim()) return;
        try {
          await apiCall('/api/dashboard/skills/install', { method: 'POST', body: JSON.stringify({ slug: newSlug.trim() }) });
          setNewSlug('');
          loadSkills();
        } catch (e) { alert("Falha ao instalar: " + e.message); }
      };

      useEffect(() => { loadSkills(); }, [isConnected]);

      return (
        <div className="flex flex-col h-full">
          <div className="flex items-center justify-between pb-4 border-b border-drk-700 mb-6">
            <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="blocks" /> Skills Hub</h2>
            <button onClick={loadSkills} className="bg-drk-800 hover:bg-drk-700 p-1.5 rounded-lg border border-drk-700 text-drk-300">
              {loading ? <div className="loader w-4 h-4"></div> : <Icon name="refresh-cw" size={16} />}
            </button>
          </div>

          <div className="flex gap-2 mb-6">
            <input
              value={newSlug}
              onChange={(e) => setNewSlug(e.target.value)}
              placeholder="github-username/skill-slug ou url direta"
              className="flex-1 bg-drk-800 border border-drk-700 rounded-xl px-4 py-2 text-sm focus:border-fox-500 outline-none"
            />
            <button onClick={installSkill} className="bg-fox-600 hover:bg-fox-500 text-white px-4 py-2 rounded-xl text-sm font-medium transition flex items-center gap-2">
              <Icon name="download" size={16} /> Instalar Skill
            </button>
          </div>

          <div className="flex-1 overflow-y-auto space-y-2 pr-2">
            {skills.length === 0 ? (
              <div className="text-center text-drk-300 py-10">Nenhuma skill instalada.</div>
            ) : (
              skills.map(s => (
                <div key={s.slug} className="bg-drk-800 border border-drk-700 rounded-xl p-4 flex items-center justify-between hover:border-drk-600 transition">
                  <div className="flex items-center gap-3">
                    <div className={`w-3 h-3 rounded-full ${s.enabled ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]' : 'bg-drk-600'}`}></div>
                    <div>
                      <div className="font-medium">{s.slug}</div>
                      <div className="text-xs text-drk-300 font-mono mt-0.5">{s.enabled ? 'Ativo na Pipeline' : 'Desabilitado'}</div>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => toggleSkill(s.slug, !s.enabled)}
                      className={`px-3 py-1.5 rounded-lg border text-xs font-medium transition ${s.enabled ? 'border-drk-600 text-drk-300 hover:text-red-400' : 'border-fox-500/30 text-fox-500 hover:bg-fox-500/10'}`}
                    >
                      {s.enabled ? 'Desativar' : 'Ativar'}
                    </button>
                    <button
                      onClick={() => {
                        if (confirm(`Remover skill '${s.slug}' permanentemente?`)) {
                          apiCall('/api/dashboard/skills/remove', { method: 'POST', body: JSON.stringify({ slug: s.slug }) }).then(loadSkills);
                        }
                      }}
                      className="px-3 py-1.5 rounded-lg border border-red-900/50 text-red-400 hover:bg-red-900/20 text-xs font-medium transition"
                    >
                      Remover
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      );
    };

    // --- Main App Orchestrator ---
    const MainApp = () => {
      const [tab, setTab] = useState('chat');
      const [token, setToken] = useState(window.localStorage.getItem('clawlite_token') || '');
      const [isConnected, setIsConnected] = useState(false);
      const [status, setStatus] = useState(null);

      // Chat State
      const [sessionId, setSessionId] = useState('dashboard-session');
      const [messages, setMessages] = useState([]);
      const wsRef = useRef(null);

      // API Utils Proxy
      const apiCall = async (path, options = {}) => {
        const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
        if (token) headers.Authorization = `Bearer ${token}`;
        const res = await fetch(path, { ...options, headers });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
        return data;
      };

      const connectWebSockets = (currentToken) => {
        if (wsRef.current) wsRef.current.close();
        const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsProto}://${location.host}/ws/chat?token=${encodeURIComponent(currentToken)}`);

        ws.onmessage = (e) => {
          const m = JSON.parse(e.data);
          if (m.type === 'chat') {
            setMessages(prev => [...prev, { role: 'agent', text: m.message?.text || '' }]);
          }
        };
        wsRef.current = ws;
      };

      const sendMessage = (text) => {
        if (!wsRef.current || wsRef.current.readyState !== 1) return;
        setMessages(prev => [...prev, { role: 'user', text }]);
        wsRef.current.send(JSON.stringify({ type: 'chat', session_id: sessionId, text }));
      };

      const doLogin = async () => {
        if (!token) return;
        try {
          const authRes = await fetch('/api/dashboard/auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
          }).then(r => r.json());

          if (authRes.ok) {
            setIsConnected(true);
            window.localStorage.setItem('clawlite_token', token);
            apiCall('/api/dashboard/bootstrap').then(b => setStatus(b.status)).catch(console.error);
            connectWebSockets(token);
          } else {
            alert("Token Inv√°lido ou Gateway offline.");
          }
        } catch (e) {
          alert("Erro de conex√£o na Auth.");
        }
      };

      useEffect(() => { if (token) doLogin(); }, []);

      // Main View Switcher
      const renderMainArea = () => {
        switch (tab) {
          case 'chat': return <ChatScreen />;
          case 'telemetry': return <TelemetryScreen />;
          case 'skills': return <SkillsScreen />;
          case 'channels': return <ConstructionScreen title="Channels Watchtower" icon="satellite-dish" />;
          default: return <ConstructionScreen title="Em Desenvolvimento" icon="wrench" />;
        }
      };

      return (
        <AppContext.Provider value={{ tab, setTab, token, setToken, status, isConnected, doLogin, apiCall, messages, sendMessage, sessionId, setSessionId }}>
          <div className="flex h-screen overflow-hidden">
            <Sidebar />
            <main className="flex-1 p-6 relative flex flex-col h-screen overflow-hidden">
              <div className="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-blue-500/5 rounded-full blur-[100px] pointer-events-none"></div>

              <div className="relative z-10 flex-1 flex flex-col h-full bg-drk-900/40 backdrop-blur-sm border border-drk-700/50 rounded-2xl shadow-2xl p-6">
                {renderMainArea()}
              </div>
            </main>
          </div>
        </AppContext.Provider>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MainApp />);

    // Manual init for lucide in non-react roots if needed
    setTimeout(() => { if (window.lucide) lucide.createIcons(); }, 100);
  </script>
</body>

</html>